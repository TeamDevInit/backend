image: docker:latest


before_script:
  - apk add --no-cache git
  - git fetch origin
  - git reset --hard origin/$CI_COMMIT_REF_NAME

services:
 - name: docker:dind
   alias: docker

stages:
    - build
    - deploy

variables:
    DOCKER_REGISTRY: docker.io
    DOCKER_IMAGE: devinit-back
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    JWT_SECRET: $JWT_SECRET
    NAVER_CLIENT_ID: $NAVER_CLIENT_ID
    NAVER_CLIENT_SECRET: $NAVER_CLIENT_SECRET
    GITHUB_CLIENT_ID: $GITHUB_CLIENT_ID
    GITHUB_CLIENT_SECRET: $GITHUB_CLIENT_SECRET
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    AWS_REGION: $AWS_REGION
    S3_BUCKET: $S3_BUCKET
    SPRING_PROFILES_ACTIVE: $SPRING_PROFILES_ACTIVE
    DB_URL_LOCAL: $DB_URL_LOCAL
    DB_USERNAME_LOCAL: $DB_USERNAME_LOCAL
    DB_PASSWORD_LOCAL: $DB_PASSWORD_LOCAL
    BASE_URL: $BASE_URL
    DOCKER_HUB_USERNAME: $DOCKER_HUB_USERNAME
    DOCKER_HUB_PASSWORD: $DOCKER_HUB_PASSWORD
    


build_job:
    stage: build
    tags:
        - build
    #image: gradle:8.3-jdk17
    before_script:
        - echo "도커 인증 잡업 시작..."
        - echo "유저 이름 : $DOCKER_HUB_USERNAME"
        - echo "유저 비번 : $DOCKER_HUB_PASSWORD"
        - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    script:
        - echo "Build the project..."
        - echo "현재 브랜치:$CI_COMMIT_REF_NAME"
        #- git clone --branch feature/24-cicd https://gitlab-ci-token:$CI_JOB_TOKEN@kdt-gitlab.elice.io/pttrack/class_01/web_project_i/team03/devinit-back.git
        #- cd devinit-back
        - docker build -t $DOCKER_IMAGE:latest .
        - docker push $DOCKER_IMAGE
    after_script:
        - docker logout

#deploy_job:
#    stage: deploy
#    tags:
#        - deploy
#    image: docker:latest
#    script:
#        - echo "Deploying the project..."
#        - docker build -t $DOCKER_IMAGE:latest .
#        - docker stop devinit-back || true && docker rm devinit-back || true
#        - docker run -d --name devinit-back  -p 8081:8080 $DOCKER_IMAGE:latest
#    environment:
#        name: dev

