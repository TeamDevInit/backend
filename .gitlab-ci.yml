image: gradle:8.3-jdk17

stages:
    - build
    - deploy
variables:
    DOCKER_REGISTRY: docker.io
    DOCKER_IMAGE: $DOCKER_HUB_USERNAME/devinit-back
    DEV_SEVICE_URL: 34.64.44.54
    JWT_SECRET: $JWT_SECRET
    NAVER_CLIENT_ID: $NAVER_CLIENT_ID
    NAVER_CLIENT_SECRET: $NAVER_CLIENT_SECRET
    GITHUB_CLIENT_ID: $GITHUB_CLIENT_ID
    GITHUB_CLIENT_SECRET: $GITHUB_CLIENT_SECRET
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    AWS_REGION: $AWS_REGION
    S3_BUCKET: $S3_BUCKET
    SPRING_PROFILES_ACTIVE: $SPRING_PROFILES_ACTIVE
    DB_URL_LOCAL: $DB_URL_LOCAL
    DB_USERNAME_LOCAL: $DB_USERNAME_LOCAL
    DB_PASSWORD_LOCAL: $DB_PASSWORD_LOCAL
    BASE_URL: $BASE_URL

services:
    - docker:dind

build_job:
    stage: build
    tags:
        - build

    script:
        - echo "Build the project.."
        - echo "현재 브랜치 $CI_COMMIT_REF_NAME"
        - git clone --branch feature/24-cicd https://gitlab-ci-token:$CI_JOB_TOKEN@kdt-gitlab.elice.io/pttrack/class_01/web_project_i/team03/devinit-back.git

        - cd devinit-back
        - chmod +x ./gradlew
        - ./gradlew clean build
    artifacts:
        name: ${CI_COMMIT_SHA}
        expire_in: 1 day
        paths:
            - devint-back/build/libs/*SNAPSHOT.jar
deploy_job:
    stage: deploy
    tags:
        - deploy
    script:
        - echo "Deploying the project.."
        - docker build -t $DOCKER_IMAGE:latest .
        - docker stop dev-container || true && docker rm dev-container || true
        - docker run -d --name dev-container -p 8080:8080 $DOCKER_IMAGE:latest
    environment:
        name: dev

